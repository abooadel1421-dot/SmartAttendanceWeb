{# app/student/templates/student/dashboard.html #}
{% extends "public_base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_content %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/student_dashboard.css') }}">
    <style>
        .card-header {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .card-body p strong {
            color: #343a40;
        }
        .badge {
            font-size: 0.9em;
            padding: 0.5em 0.75em;
            border-radius: 0.35rem;
        }
        .list-group-item span {
            font-size: 0.95rem;
        }
        .no-data-message {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
        .profile-image-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 1.5rem auto;
            border: 3px solid #007bff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .profile-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* ØªÙ…ÙŠÙŠØ² Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ */
        .student-dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        /* ØªØµÙ…ÙŠÙ… Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
        .stat-card .card-body {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 1.5rem;
        }
        .stat-card .stat-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            line-height: 1;
        }
        .stat-card .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        /* ğŸŸ¢ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
        .notification-card .alert {
            margin-bottom: 0.75rem; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        }
        .notification-card .alert strong {
            color: #343a40; /* Ù„ÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ */
        }
        .notification-card .alert small {
            font-size: 0.8em;
            color: #6c757d;
        }
        .notification-card .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .notification-card .alert-info strong {
            color: #0c5460;
        }
        .notification-card .alert-secondary {
            background-color: #e2e3e5;
            border-color: #d6d8db;
            color: #383d41;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    {# Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ - Ù…ÙØ¹Ø¯Ù„Ø© Ù„ØªÙƒÙˆÙ† Ù…Ù…ÙŠØ²Ø© #}
    <div class="p-4 mb-4 student-dashboard-header rounded-3 shadow-sm text-center">
        <div class="container-fluid py-3">
            <div class="profile-image-container mx-auto bg-white">
                <img src="{{ url_for('static', filename='images/default_student_avatar.png') }}" 
                     alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨" 
                     onerror="this.src='https://via.placeholder.com/120?text=Ø·Ø§Ù„Ø¨'">
            </div>
            <h1 class="display-5 fw-bold mb-3">
                <i class="fas fa-user-graduate me-2"></i>
                Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ student.first_name }} {{ student.last_name }}!
            </h1>
            <p class="fs-5 mb-2">
                <span class="badge bg-light text-dark">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ: {{ student.student_id_number }}</span>
            </p>
            <p class="lead mb-0">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ. Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙˆØ³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±Ùƒ.</p>
        </div>
    </div>

    {# ğŸŸ¢ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© (Alert) - Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ ØªØ­Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù…Ø¨Ø§Ø´Ø±Ø© #}
    {% if unread_notifications_count > 0 %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-bell me-2"></i> Ù„Ø¯ÙŠÙƒ <strong>{{ unread_notifications_count }}</strong> Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©!
            <a href="{{ url_for('student.view_my_notifications') }}" class="alert-link ms-3 fw-bold">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¢Ù†</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {# Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ #}
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card shadow-sm stat-card border-left-primary">
                <div class="card-body">
                    <i class="fas fa-calendar-check stat-icon text-primary"></i>
                    <div class="stat-value text-primary">{{ distinct_present_days }}</div>
                    <div class="stat-label">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± (ÙØ±ÙŠØ¯)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card shadow-sm stat-card border-left-danger">
                <div class="card-body">
                    <i class="fas fa-calendar-times stat-icon text-danger"></i>
                    <div class="stat-value text-danger">{{ absent_count }}</div>
                    <div class="stat-label">Ù…Ø±Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card shadow-sm stat-card border-left-warning">
                <div class="card-body">
                    <i class="fas fa-clock stat-icon text-warning"></i>
                    <div class="stat-value text-warning">{{ late_arrivals_count }}</div>
                    <div class="stat-label">Ù…Ø±Ø§Øª Ø§Ù„ØªØ£Ø®ÙŠØ±</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card shadow-sm stat-card border-left-success">
                <div class="card-body">
                    <i class="fas fa-chart-pie stat-icon text-success"></i>
                    <div class="stat-value text-success">{{ attendance_percentage }}%</div>
                    <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        {# Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ© #}
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100 border-primary">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-person-circle me-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©
                </div>
                <div class="card-body">
                    <p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> {{ student.major if student.major else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
                    <p><strong>Ø§Ù„Ù…Ø³ØªÙˆÙ‰/Ø§Ù„Ø¯Ø±Ø¬Ø©:</strong> {{ student.grade if student.grade else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
                    <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</strong> {{ student.date_of_birth.strftime('%Y-%m-%d') if student.date_of_birth else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
                    <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙŠØ¯:</strong>
                        {% if student.is_active %}
                            <span class="badge bg-success">Ù†Ø´Ø·</span>
                        {% else %}
                            <span class="badge bg-danger">ØºÙŠØ± Ù†Ø´Ø·</span>
                        {% endif %}
                    </p>
                    <hr>
                    <h6>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆÙ„ÙŠ:</h6>
                    <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„ÙˆÙ„ÙŠ:</strong> {{ student.parent_email if student.parent_email else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
                    <p><strong>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„ÙˆÙ„ÙŠ:</strong> {{ student.parent_phone_number if student.parent_phone_number else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
                </div>
            </div>
        </div>

        {# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ© - ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡Ø§ #}
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100 border-info">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-credit-card-fill me-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                </div>
                <div class="card-body">
                    {% if card %}
                        {# ØªÙ… Ø­Ø°Ù Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (UID) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ #}
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong> {{ card.issued_at.strftime('%Y-%m-%d') if card.issued_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
                        <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong>
                            {% if card.status == 'ACTIVE' %}
                                <span class="badge bg-success">Ù†Ø´Ø·Ø©</span>
                            {% elif card.status == 'INACTIVE' %}
                                <span class="badge bg-warning">ØºÙŠØ± Ù†Ø´Ø·Ø©</span>
                            {% elif card.status == 'LOST' %}
                                <span class="badge bg-danger">Ù…ÙÙ‚ÙˆØ¯Ø©</span>
                            {% else %}
                                <span class="badge bg-secondary">ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©</span>
                            {% endif %}
                        </p>
                        <p><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> {{ card.updated_at.strftime('%Y-%m-%d %I:%M:%S %p') if card.updated_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
                    {% else %}
                        <div class="no-data-message alert alert-warning">
                            <i class="bi bi-x-circle-fill me-2"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø³Ø¬Ù„Ø© Ø¨Ø§Ø³Ù…Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø®ÙŠØ±Ø© - ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø­Ø§Ù„Ø© #}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-success">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-calendar-check-fill me-2"></i>Ø¢Ø®Ø± Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±
                </div>
                <div class="card-body">
                    {% if attendance_logs %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th> {# ØªÙ… ØªØºÙŠÙŠØ± "Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©" Ø¥Ù„Ù‰ "Ø§Ù„Ø­Ø§Ù„Ø©" #}
                                        <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th> {# ØªÙ… ØªØºÙŠÙŠØ± "Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù…ÙˆÙ‚Ø¹" Ø¥Ù„Ù‰ "Ø§Ù„Ù…ÙˆÙ‚Ø¹" #}
                                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th> {# Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© #}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in attendance_logs %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>{{ log.timestamp.strftime('%Y-%m-%d') }}</td> {# Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· #}
                                            <td>{{ log.timestamp.strftime('%I:%M %p') }}</td> {# Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø¨ØµÙŠØºØ© 12 Ø³Ø§Ø¹Ø© (HH:MM AM/PM) #}
                                            <td>
                                                {# Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© enum Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¹Ø±Ø¶ #}
                                                {% if log.final_status.value == 'PRESENT' %}
                                                    <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>{{ log.status.value }}</span>
                                                {% elif log.status.value == 'ABSENT' %}
                                                    <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>{{ log.status.value }}</span>
                                                {% elif log.status.value == 'LATE' %}
                                                    <span class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle me-1"></i>{{ log.status.value }}</span>
                                                {% elif log.status.value == 'EXCUSED' %}
                                                    <span class="badge bg-info"><i class="fas fa-file-alt me-1"></i>{{ log.status.value }}</span>
                                                {# Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ø°Ø§Øª Ù…Ø¹Ù†Ù‰ Ù„Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ§Ù‚ØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø®ÙØ§Ø¦Ù‡Ø§ Ø£Ùˆ Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ #}
                                                {% elif log.status.value == 'ENTER' %}
                                                    <span class="badge bg-primary"><i class="fas fa-sign-in-alt me-1"></i>Ø¯Ø®ÙˆÙ„</span>
                                                {% elif log.status.value == 'EXIT' %}
                                                    <span class="badge bg-secondary"><i class="fas fa-sign-out-alt me-1"></i>Ø®Ø±ÙˆØ¬</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ log.status.value }}</span>
                                                {% endif %}
                                            </td>
                                            {# Ù‡Ù†Ø§ ØªÙ… ØªØºÙŠÙŠØ± log.device.name Ø¥Ù„Ù‰ log.device.location #}
                                            <td>{{ log.device.location if log.device else 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' }}</td>
                                            <td>{{ log.notes if log.notes else '-' }}</td> {# Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª #}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="no-data-message alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ± Ø­Ø¯ÙŠØ«Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# ğŸŸ¢ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø§Ù„Ù…Ø¹Ø¯Ù„) #}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-warning notification-card"> {# ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ notification-card #}
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-bell me-2"></i>Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙŠ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
                </div>
                <div class="card-body">
                    {% if notifications %}
                        {% for notification in notifications[:5] %} {# ğŸŸ¢ Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ #}
                        <div class="alert {% if notification.status == 'unread' %}alert-info{% else %}alert-secondary{% endif %} mb-2" role="alert">
                            <i class="fas fa-user-tie me-2"></i>
                            <strong>Ù…Ù†: {{ notification.sender.full_name if notification.sender.full_name else notification.sender.username }}</strong>
                            <small class="float-end text-muted">{{ notification.timestamp.strftime('%Y-%m-%d %I:%M %p') }}</small><br>
                            {{ notification.message }}
                        </div>
                        {% endfor %}
                        <div class="text-end mt-3">
                            <a href="{{ url_for('student.view_my_notifications') }}" class="btn btn-sm btn-outline-primary">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª <i class="fas fa-arrow-right ms-2"></i></a>
                        </div>
                    {% else %}
                        <div class="no-data-message alert alert-light">
                            <i class="bi bi-info-circle-fill me-2"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ø±Ø¯Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/student_dashboard.js') }}"></script>
{% endblock %}