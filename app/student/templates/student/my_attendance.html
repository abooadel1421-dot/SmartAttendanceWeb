{# app/templates/student/my_attendance.html #}
{% extends "public_base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_content %}
    {{ super() }}
    <style>
        .report-table td select {
            width: 150px; /* Ù„Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
        }
        .card-header i {
            font-size: 1.2rem;
            vertical-align: middle;
        }
        .badge {
            padding: 0.5em 0.75em;
            font-size: 0.85em;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4 text-center">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-clipboard-list me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
        </div>
        <div class="card-body">
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                Ù‡Ù†Ø§ ØªØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±Ùƒ ÙˆØºÙŠØ§Ø¨Ùƒ Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹Ù…ÙŠÙ…Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¹Ø¸Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³. ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø°Ø± Ù„Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± ÙÙŠÙ‡Ø§ "ØºØ§Ø¦Ø¨".
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover report-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th> {# ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ #}
                            <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th>
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø°Ø±</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if attendance_records %}
                            {% for record_entry in attendance_records %}
                                {% set log = record_entry.log %}
                                {% set excuse = record_entry.excuse %}
                                {# ğŸŸ¢ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ù†Ø­ØªØ§Ø¬Ù‡ Ù„ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ #}
                                {% set actual_entry_time = record_entry.actual_entry_time %} 
                                <tr>
                                    <td>{{ log.timestamp.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {# ğŸŸ¢ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ #}
                                        {% if log.device %}
                                            {{ log.device.location }}
                                        {% else %}
                                            ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ
                                        {% endif %}
                                    </td>
                                    <td>
                                        {# ğŸŸ¢ Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† record_entry #}
                                        {% if actual_entry_time %}
                                            {{ actual_entry_time.strftime('%I:%M %p') }} {# ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª (Ù…Ø«Ù„Ø§Ù‹ 09:30 AM) #}
                                        {% else %}
                                            -- {# Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„ ÙØ¹Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… #}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.final_status == FinalAttendanceStatus.PRESENT %}
                                            <span class="badge bg-success">{{ log.final_status.value }}</span>
                                        {% elif log.final_status == FinalAttendanceStatus.LATE %}
                                            <span class="badge bg-warning text-dark">{{ log.final_status.value }}</span>
                                        {% elif log.final_status == FinalAttendanceStatus.ABSENT %}
                                            <span class="badge bg-danger">{{ log.final_status.value }}</span>
                                        {% elif log.final_status == FinalAttendanceStatus.EXCUSED %}
                                            <span class="badge bg-info">{{ log.final_status.value }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if excuse %}
                                            {% if excuse.status == ExcuseStatus.APPROVED %}
                                                <span class="badge bg-success">Ø¹Ø°Ø± Ù…Ù‚Ø¨ÙˆÙ„</span>
                                            {% elif excuse.status == ExcuseStatus.PENDING %}
                                                <span class="badge bg-warning text-dark">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                                            {% elif excuse.status == ExcuseStatus.REJECTED %}
                                                <span class="badge bg-danger">Ø¹Ø°Ø± Ù…Ø±ÙÙˆØ¶</span>
                                            {% else %}
                                                <span class="badge bg-secondary">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                                            {% endif %}
                                            <small class="text-muted d-block">Ø§Ù„Ø³Ø¨Ø¨: {{ excuse.reason|truncate(50) }}</small>
                                        {% else %}
                                            <span class="badge bg-secondary">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø°Ø±</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.final_status == FinalAttendanceStatus.ABSENT and (not excuse or excuse.status == ExcuseStatus.REJECTED) %}
                                            <a href="{{ url_for('student.submit_excuse', date=log.timestamp.strftime('%Y-%m-%d')) }}" class="btn btn-sm btn-primary">ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø°Ø±</a>
                                        {% elif excuse %}
                                            <button class="btn btn-sm btn-secondary" disabled>ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø°Ø±</button>
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ± Ø£Ùˆ ØºÙŠØ§Ø¨ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if absent_dates_for_excuse %}
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-info text-white">
                <i class="fas fa-calendar-times me-2"></i>Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø°Ø± Ø¹Ù†Ù‡Ø§
            </div>
            <div class="card-body">
                <p>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ ÙÙŠÙ‡Ø§ ØºØ§Ø¦Ø¨Ø§Ù‹ ÙˆÙ„Ù… ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø°Ø± Ù…Ø¹ØªÙ…Ø¯ Ø¹Ù†Ù‡Ø§ Ø¨Ø¹Ø¯:</p>
                <div class="d-flex flex-wrap gap-2">
                    {% for absent_date in absent_dates_for_excuse %}
                        <a href="{{ url_for('student.submit_excuse', date=absent_date.strftime('%Y-%m-%d')) }}" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-plus-circle me-1"></i>ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø°Ø± Ù„Ù€ {{ absent_date.strftime('%Y-%m-%d') }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}