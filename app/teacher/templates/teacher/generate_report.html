{# app/templates/teacher/generate_report.html #}
{% extends "public_base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_content %}
    {{ super() }}
    <style>
        .report-table td select {
            width: 150px; /* Ù„Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
        }
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
        .card-header i {
            font-size: 1.2rem;
            vertical-align: middle;
        }
        .form-label {
            font-weight: bold;
        }
        .badge {
            padding: 0.5em 0.75em;
            font-size: 0.85em;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4 text-center">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ¹Ø¯ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-calendar-alt me-2"></i>ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('teacher.generate_report') }}">
                {{ form.hidden_tag() }}
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        {{ form.report_date.label(class="form-label") }}
                        {{ form.report_date(class="form-control") }}
                        {% for error in form.report_date.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-3">
                        {{ form.start_time.label(class="form-label") }}
                        {{ form.start_time(class="form-control") }}
                        {% for error in form.start_time.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-3">
                        {{ form.end_time.label(class="form-label") }}
                        {{ form.end_time(class="form-control") }}
                        {% for error in form.end_time.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-2">
                        {{ form.submit(class="btn btn-primary w-100") }}
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if report_data %}
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-success text-white">
                {# ğŸŸ¢ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† start_time Ùˆ end_time Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ strftime #}
                <i class="fas fa-clipboard-list me-2"></i>ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù€ {{ report_date.strftime('%Y-%m-%d') }} 
                {% if start_time and end_time %}(Ù…Ù† {{ start_time.strftime('%H:%M') }} Ø¥Ù„Ù‰ {{ end_time.strftime('%H:%M') }}){% endif %}
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover report-table" id="attendanceReportTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„ÙØ¹Ù„ÙŠØ©)</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</th>
                                <th>Ø¹Ø°Ø± Ù…Ø¹ØªÙ…Ø¯ØŸ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in report_data %}
                            <tr data-student-id="{{ entry.student.id }}" data-log-id="{{ entry.log_id }}">
                                <td>{{ loop.index }}</td>
                                <td>{{ entry.student.full_name }}</td>
                                <td>{{ entry.entry_time }}</td>
                                <td>
                                    {# ğŸŸ¢ Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† ØªØ³ØªØ®Ø¯Ù… "EXCUSED" Ø¥Ø°Ø§ Ù‚Ù…Ù†Ø§ Ø¨ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù€ Enum #}
                                    {% if entry.calculated_status.name == 'PRESENT' %}
                                        <span class="badge bg-success">{{ entry.calculated_status.value }}</span>
                                    {% elif entry.calculated_status.name == 'LATE' %}
                                        <span class="badge bg-warning text-dark">{{ entry.calculated_status.value }}</span>
                                    {% elif entry.calculated_status.name == 'EXCUSED' %} {# ğŸŸ¢ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ #}
                                        <span class="badge bg-info">{{ entry.calculated_status.value }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ entry.calculated_status.value }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select class="form-select status-select" 
                                            data-student-id="{{ entry.student.id }}" 
                                            data-log-id="{{ entry.log_id }}"
                                            data-report-date="{{ report_date.strftime('%Y-%m-%d') }}">
                                        {% for status_enum in final_statuses %}
                                            <option value="{{ status_enum.name }}"
                                                    {% if entry.calculated_status.name == status_enum.name %} selected {% endif %}>
                                                {{ status_enum.value }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    {% if entry.has_approved_excuse %}
                                        <i class="fas fa-check-circle text-success" title="ÙŠÙˆØ¬Ø¯ Ø¹Ø°Ø± Ù…Ø¹ØªÙ…Ø¯"></i> Ù†Ø¹Ù…
                                    {% else %}
                                        <i class="fas fa-times-circle text-danger" title="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø°Ø± Ù…Ø¹ØªÙ…Ø¯"></i> Ù„Ø§
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-primary" id="finalizeReportBtn">
                        <i class="fas fa-paper-plane me-2"></i>ØªØ¹Ù…ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                </div>
            </div>
        </div>
    {% elif form.is_submitted() and not form.errors %} {# Ù„Ùˆ Ø§Ù„ÙÙˆØ±Ù… Ø£ÙØ±Ø³Ù„ ÙˆÙ„Ù… ØªØ¸Ù‡Ø± Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¹Ù†ÙŠ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª #}
        <div class="alert alert-info mt-4" role="alert">
            <i class="fas fa-info-circle me-2"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ù„Ù„ÙØªØ±Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†.
        </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯ (ØªØ¹Ø¯ÙŠÙ„ ÙØ±Ø¯ÙŠ)
            document.querySelectorAll('.status-select').forEach(selectElement => {
                selectElement.addEventListener('change', function() {
                    const studentId = this.dataset.studentId;
                    const logId = this.dataset.logId; // Ù‚Ø¯ ÙŠÙƒÙˆÙ† null Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙØ¹Ù„ÙŠ
                    const reportDate = this.dataset.reportDate;
                    const newStatus = this.value;

                    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªØ£ÙƒÙŠØ¯ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
                    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¥Ø°Ø§ Ø£Ù„ØºÙ‰ Ø§Ù„Ø§Ø¹Ø¸Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³
                        // Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ dataset Ù…Ø«Ù„Ø§Ù‹
                        // For example: this.value = this.dataset.originalStatus;
                        return;
                    }

                    fetch('{{ url_for("teacher.update_report_status") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            student_id: studentId,
                            log_id: logId,
                            report_date: reportDate,
                            new_status: newStatus
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ UI Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±ØŒ Ø£Ùˆ ÙÙ‚Ø· Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ DB
                            // window.location.reload(); // Ù‚Ø¯ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ÙƒÙ„ ØªØºÙŠÙŠØ± ÙØ±Ø¯ÙŠ
                        } else {
                            alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + data.message);
                            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ Ø¥Ø°Ø§ ØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.');
                    });
                });
            });

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± "ØªØ¹Ù…ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
            document.getElementById('finalizeReportBtn').addEventListener('click', function() {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ù…ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.')) {
                    return;
                }

                // ğŸŸ¢ Ù‡Ù†Ø§ Ø§Ù„ØªØµØ­ÙŠØ­: ÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ report_date Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
                const reportDate = {% if report_date %}'{{ report_date.strftime("%Y-%m-%d") }}'{% else %}null{% endif %};

                if (reportDate === null) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙØªØ±Ø© Ù„Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ¥Ù†Ø´Ø§Ø¡Ù‡ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ù…ÙŠÙ….');
                    return;
                }
                
                const reportDataToFinalize = [];
                document.querySelectorAll('#attendanceReportTable tbody tr').forEach(row => {
                    const studentId = row.dataset.studentId;
                    const logId = row.dataset.logId;
                    const finalStatus = row.querySelector('.status-select').value;
                    reportDataToFinalize.push({
                        student_id: studentId,
                        log_id: logId, // ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„Ù‡ ÙƒÙ…Ø¹Ù„ÙˆÙ…Ø© Ø¥Ø¶Ø§ÙÙŠØ©ØŒ Ù„ÙƒÙ†Ù†Ø§ Ù‚Ø¯ Ù„Ø§ Ù†Ø­ØªØ§Ø¬Ù‡ ÙÙŠ Ø§Ù„ØªØ¹Ù…ÙŠÙ…
                        final_status: finalStatus
                    });
                });

                fetch('{{ url_for("teacher.finalize_report") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        report_date: reportDate,
                        report_data: reportDataToFinalize
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    } else {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ¹Ù…ÙŠÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ù…ÙŠÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
                });
            });
        });
    </script>
{% endblock %}